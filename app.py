import streamlit as st
from typing import List, Dict


# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ê³„ì ˆ ë³€í™”ê°€ ìƒê¸°ëŠ” ê¹Œë‹­ - ìˆ˜ì—… ë³´ì¡° ë„êµ¬",
    page_icon="ğŸŒ",
    layout="wide",
)


# -----------------------------
# ë°œë¬¸ ì¹´ë“œ ë°ì´í„°
# -----------------------------
def get_default_cards() -> List[Dict]:
    """ìˆ˜ì—…ì—ì„œ ì‚¬ìš©í•  ë°œë¬¸ ì¹´ë“œë¥¼ ì •ì˜í•©ë‹ˆë‹¤."""
    return [
        {
            "id": "obs_sun_appearance",
            "stage": "ë„ì… Â· ê´€ì°°",
            "label": "ë„ì…-ê´€ì°°: íƒœì–‘ì´ ë¹„ì¹˜ëŠ” ëª¨ìŠµ",
            "question": "ì—¬ë¦„ê³¼ ê²¨ìš¸ì— íƒœì–‘ì´ ë¹„ì¹˜ëŠ” ëª¨ìŠµì€ ì–´ë–»ê²Œ ë‹¤ë¥¼ê¹Œìš”?",
            "expected_answers": [
                "ì—¬ë¦„ì—ëŠ” íƒœì–‘ì´ ë” ë†’ì´ ë–  ìˆê³ , ê²¨ìš¸ì—ëŠ” ë‚®ê²Œ ë– ìš”.",
                "ì—¬ë¦„ì—ëŠ” í–‡ë¹›ì´ ê°•ê³  ëˆˆì´ ë¶€ì‹œê³ , ê²¨ìš¸ì—ëŠ” í–‡ë¹›ì´ ì•½í•˜ê²Œ ëŠê»´ì ¸ìš”.",
            ],
            "feedback_rules": {},
            "resources": [
                {
                    "id": "axis_tilt",
                    "title": "ì§€êµ¬ ìì „ì¶• 23.5ë„ ê¸°ìš¸ê¸° ê·¸ë¦¼",
                    "type": "image",
                    "default_url": "https://example.com/earth-axis-tilt-23-5deg.png",
                    "description": "ì§€êµ¬ê°€ ìì „ì¶•ì´ ê¸°ìš¸ì–´ì§„ ì±„ë¡œ íƒœì–‘ ì£¼ìœ„ë¥¼ ë„ëŠ” ëª¨ìŠµì„ ë³´ì—¬ ì£¼ëŠ” ê·¸ë¦¼ì…ë‹ˆë‹¤.",
                },
                {
                    "id": "sun_height",
                    "title": "ì—¬ë¦„/ê²¨ìš¸ íƒœì–‘ ë†’ì´ ë¹„êµ ê·¸ë¦¼",
                    "type": "image",
                    "default_url": "https://example.com/sun-altitude-summer-winter.png",
                    "description": "ê°™ì€ ì¥ì†Œì—ì„œ ì—¬ë¦„ê³¼ ê²¨ìš¸ì— íƒœì–‘ì´ ì–´ëŠ ë†’ì´ê¹Œì§€ ì˜¬ë¼ê°€ëŠ”ì§€ ë¹„êµí•œ ê·¸ë¦¼ì…ë‹ˆë‹¤.",
                },
            ],
            "teacher_notes": {
                "extra_questions": [
                    "ì—¬ë¦„ê³¼ ê²¨ìš¸ì— ê·¸ë¦¼ì ê¸¸ì´ë„ í•¨ê»˜ ë– ì˜¬ë ¤ ë³´ë©´ ì–´ë–¤ ì°¨ì´ê°€ ìˆì„ê¹Œìš”?",
                    "íƒœì–‘ì´ ëœ¨ê³  ì§€ëŠ” ìœ„ì¹˜ë„ ê³„ì ˆë§ˆë‹¤ ë‹¬ë¼ì§€ëŠ”ì§€ ì´ì•¼ê¸°í•´ ë³¼ê¹Œìš”?",
                ],
                "teacher_point": "í•™ìƒë“¤ì˜ ë§ ì†ì—ì„œ 'íƒœì–‘ ë†’ì´', 'í–‡ë¹›ì˜ ëŠë‚Œ', 'ê·¸ë¦¼ì ê¸¸ì´' ê°™ì€ í‘œí˜„ì„ ëŒì–´ë‚´ì–´, ë‚˜ì¤‘ì— íƒœì–‘ ê³ ë„ ê°œë…ìœ¼ë¡œ ì—°ê²°í•  ì¤€ë¹„ë¥¼ í•©ë‹ˆë‹¤.",
            },
        },
        {
            "id": "obs_shadow_length",
            "stage": "ë„ì… Â· ê´€ì°°",
            "label": "ë„ì…-ê´€ì°°: ê·¸ë¦¼ì ê¸¸ì´",
            "question": "ì—¬ë¦„ê³¼ ê²¨ìš¸ì— ê°™ì€ ì‹œê°„ì— ì„œ ìˆìœ¼ë©´, ê·¸ë¦¼ì ê¸¸ì´ëŠ” ì–´ë–»ê²Œ ë‹¬ë¼ì§ˆê¹Œìš”?",
            "expected_answers": [
                "ì—¬ë¦„ì—ëŠ” ê·¸ë¦¼ìê°€ ì§§ê³ , ê²¨ìš¸ì—ëŠ” ê·¸ë¦¼ìê°€ ê¸¸ì–´ìš”.",
                "ê²¨ìš¸ì—ëŠ” í•´ê°€ ë‚®ê²Œ ìˆì–´ì„œ ê·¸ë¦¼ìê°€ í›¨ì”¬ ê¸¸ì–´ì ¸ìš”.",
            ],
            "feedback_rules": {},
            "resources": [
                {
                    "id": "shadow_compare",
                    "title": "ì—¬ë¦„/ê²¨ìš¸ ê·¸ë¦¼ì ê¸¸ì´ ë¹„êµ ì‚¬ì§„",
                    "type": "image",
                    "default_url": "https://example.com/shadow-length-summer-winter.png",
                    "description": "ê°™ì€ ì‹œê°„ì— ì°ì€ ì—¬ë¦„ê³¼ ê²¨ìš¸ì˜ ê·¸ë¦¼ì ê¸¸ì´ë¥¼ ë¹„êµí•œ ì‚¬ì§„ì…ë‹ˆë‹¤.",
                }
            ],
            "teacher_notes": {
                "extra_questions": [
                    "ê·¸ë¦¼ìê°€ ê¸¸ë‹¤ëŠ” ê²ƒì€ íƒœì–‘ì´ í•˜ëŠ˜ì—ì„œ ì–´ëŠ ìª½ì— ìˆë‹¤ëŠ” ëœ»ì¼ê¹Œìš”?",
                    "ê·¸ë¦¼ì ê¸¸ì´ì™€ íƒœì–‘ ë†’ì´ëŠ” ì–´ë–¤ ê´€ê³„ê°€ ìˆì„ì§€ ìŠ¤ìŠ¤ë¡œ ë§í•´ ë³´ê²Œ í•´ ì£¼ì„¸ìš”.",
                ],
                "teacher_point": "ê·¸ë¦¼ì ê¸¸ì´ ê²½í—˜ì„ í†µí•´ íƒœì–‘ ê³ ë„ê°€ ë‚®ì„ìˆ˜ë¡ ê·¸ë¦¼ìê°€ ê¸¸ì–´ì§„ë‹¤ëŠ” ì§ê´€ì„ ìŒ“ê²Œ í•©ë‹ˆë‹¤.",
            },
        },
        {
            "id": "reason_sunlight",
            "stage": "ì „ê°œ Â· ì¶”ë¡ ",
            "label": "ì „ê°œ-ì¶”ë¡ : í–‡ë¹›ì´ ë” ê°•í•˜ê²Œ ëŠê»´ì§€ëŠ” ê¹Œë‹­",
            "question": "ì™œ ì—¬ë¦„ì—ëŠ” í–‡ë¹›ì´ ë” ê°•í•˜ê²Œ ëŠê»´ì§ˆê¹Œìš”?",
            "expected_answers": [
                "ì—¬ë¦„ì—ëŠ” íƒœì–‘ì´ ë†’ì´ ë–  ìˆì–´ì„œ í–‡ë¹›ì´ ë” ì„¸ê²Œ ë‚´ë ¤ì™€ìš”.",
                "í–‡ë¹›ì´ ë” ìœ„ì—ì„œ ë°”ë¡œ ë‚´ë ¤ì™€ì„œ ê°™ì€ ê³³ì— ë” ë§ì´ ëª¨ì—¬ìš”.",
            ],
            "feedback_rules": {},
            "resources": [
                {
                    "id": "angle_energy",
                    "title": "ìˆ˜ì§/ë¹„ìŠ¤ë“¬í•œ í–‡ë¹›ê³¼ ì—ë„ˆì§€ ë¶„í¬ ê·¸ë¦¼",
                    "type": "image",
                    "default_url": "https://example.com/sunlight-angle-comparison.png",
                    "description": "ê°™ì€ ì–‘ì˜ í–‡ë¹›ì´ ìˆ˜ì§ìœ¼ë¡œ ë“¤ì–´ì˜¬ ë•Œì™€ ë¹„ìŠ¤ë“¬íˆ ë“¤ì–´ì˜¬ ë•Œ, ë‹¨ìœ„ ë©´ì ì— ë„ë‹¬í•˜ëŠ” ì—ë„ˆì§€ ì°¨ì´ë¥¼ ë³´ì—¬ ì£¼ëŠ” ê·¸ë¦¼ì…ë‹ˆë‹¤.",
                }
            ],
            "teacher_notes": {
                "extra_questions": [
                    "ì†ì „ë“±ì„ ì±…ìƒì— ë¹„ì¶œ ë•Œ, ë°”ë¡œ ìœ„ì—ì„œ ë¹„ì¶œ ë•Œì™€ ë¹„ìŠ¤ë“¬íˆ ë¹„ì¶œ ë•Œì˜ ë°ê¸°ëŠ” ì–´ë–»ê²Œ ë‹¤ë¥¸ê°€ìš”?",
                    "ê°™ì€ ì–‘ì˜ ë¹›ì´ ë” ì‘ì€ ê³³ì— ëª¨ì´ë©´ ì–´ë–»ê²Œ ëŠê»´ì§ˆì§€ í•™ìƒì´ ë§í•´ ë³´ê²Œ í•´ ì£¼ì„¸ìš”.",
                ],
                "teacher_point": "ë¹›ì˜ ì…ì‚¬ê°ê³¼ ë‹¨ìœ„ ë©´ì ë‹¹ ì—ë„ˆì§€ ì–‘ì„ ì—°ê²°í•˜ì—¬, ë‹¨ìˆœíˆ 'ì—¬ë¦„ì´ë‹ˆê¹Œ ëœ¨ê²ë‹¤'ê°€ ì•„ë‹ˆë¼ 'ë¹›ì˜ ê°ë„'ë¡œ ì‚¬ê³ í•˜ê²Œ ë•ìŠµë‹ˆë‹¤.",
            },
        },
        {
            "id": "misconception_distance",
            "stage": "ì „ê°œ Â· ê²€ì¦",
            "label": "ì „ê°œ-ê²€ì¦: ê±°ë¦¬ ì˜¤ê°œë… í™•ì¸",
            "question": "ê³„ì ˆì€ ì§€êµ¬ê°€ íƒœì–‘ì— ê°€ê¹Œì›Œì ¸ì„œ ë˜ëŠ” ë©€ì–´ì ¸ì„œ ìƒê¸´ë‹¤ê³  ë§í•´ë„ ë ê¹Œìš”?",
            "expected_answers": [
                "ê°€ê¹Œì›Œì„œ ë¥ê³ , ë©€ì–´ì„œ ì¶”ìš´ ê±°ë¼ê³  ìƒê°í–ˆì–´ìš”.",
                "ì¡°ê¸ˆì€ ê±°ë¦¬ë„ ê´€ê³„ê°€ ìˆì„ ê²ƒ ê°™ì€ë°, ê·¸ê²ƒë§Œìœ¼ë¡œëŠ” ì„¤ëª…ì´ ì•ˆ ë˜ëŠ” ê²ƒ ê°™ì•„ìš”.",
            ],
            "feedback_rules": {},
            "resources": [
                {
                    "id": "orbit_shape",
                    "title": "ì§€êµ¬ ê³µì „ ê¶¤ë„ì™€ ê±°ë¦¬ ë³€í™” ê·¸ë¦¼",
                    "type": "image",
                    "default_url": "https://example.com/earth-orbit-distance.png",
                    "description": "ì§€êµ¬ê°€ íƒœì–‘ì„ íƒ€ì› ê¶¤ë„ë¡œ ëŒì§€ë§Œ, ê±°ë¦¬ ì°¨ì´ëŠ” ê³„ì ˆì„ ì„¤ëª…í•˜ê¸°ì—” í¬ì§€ ì•Šë‹¤ëŠ” ì ì„ ë³´ì—¬ ì£¼ëŠ” ê·¸ë¦¼ì…ë‹ˆë‹¤.",
                }
            ],
            "teacher_notes": {
                "extra_questions": [
                    "ë§Œì•½ ê±°ë¦¬ê°€ ì •ë§ í¬ê²Œ ë‹¬ë¼ì§„ë‹¤ë©´, ë´„ê³¼ ê°€ì„ì˜ ì˜¨ë„ëŠ” ì–´ë–»ê²Œ ë˜ì–´ì•¼ í• ê¹Œìš”?",
                    "ìš°ë¦¬ë‚˜ë¼ê°€ ê²¨ìš¸ì¼ ë•Œ, ì§€êµ¬ì˜ ë‹¤ë¥¸ ì§€ì—­ì€ ì–´ë–¤ ê³„ì ˆì¸ì§€ í•¨ê»˜ ìƒê°í•´ ë³´ê²Œ í•´ ì£¼ì„¸ìš”.",
                ],
                "teacher_point": "ê±°ë¦¬ ì˜¤ê°œë…ì„ ë°”ë¡œ 'í‹€ë ¸ë‹¤'ê³  ë§í•˜ê¸°ë³´ë‹¤, ê±°ë¦¬ë§Œìœ¼ë¡œëŠ” ì„¤ëª…í•˜ê¸° ì–´ë ¤ìš´ ì‚¬ë¡€ë¥¼ í•¨ê»˜ ë– ì˜¬ë¦¬ê²Œ í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.",
            },
        },
        {
            "id": "elab_tilt",
            "stage": "ì „ê°œ Â· ì •êµí™”",
            "label": "ì „ê°œ-ì •êµí™”: ìì „ì¶• ê¸°ìš¸ê¸° ì˜ë¯¸",
            "question": "â€˜ì§€êµ¬ì˜ ìì „ì¶•ì´ ê¸°ìš¸ì–´ì ¸ ìˆë‹¤â€™ëŠ” ë§ì€ ì–´ë–¤ ëœ»ì¼ê¹Œìš”?",
            "expected_answers": [
                "ì§€êµ¬ê°€ ì„¸ì›Œì ¸ì„œ ë„ëŠ” ê²Œ ì•„ë‹ˆë¼ ì•½ê°„ ê¸°ìš¸ì–´ì§„ ì±„ë¡œ ëŒê³  ìˆì–´ìš”.",
                "ì—°í•„ì„ ì•½ê°„ ë¹„ìŠ¤ë“¬íˆ ì„¸ì›Œì„œ ëŒë¦¬ëŠ” ê²ƒì²˜ëŸ¼, ì§€êµ¬ë„ ê¸°ìš¸ì–´ì§„ ì±„ë¡œ íƒœì–‘ ì£¼ìœ„ë¥¼ ëŒì•„ìš”.",
            ],
            "feedback_rules": {},
            "resources": [
                {
                    "id": "tilt_demo",
                    "title": "ìì „ì¶• ê¸°ìš¸ê¸° ëª¨í˜• ì˜ìƒ",
                    "type": "video",
                    "default_url": "https://example.com/earth-tilt-demo.mp4",
                    "description": "ì§€êµ¬ë³¸ì„ ê¸°ìš¸ì—¬ì„œ ëŒë¦¬ëŠ” ê°„ë‹¨í•œ ì‹¤í—˜ ì˜ìƒì„ ë³´ì—¬ ì£¼ì„¸ìš”.",
                }
            ],
            "teacher_notes": {
                "extra_questions": [
                    "ìì „ì¶•ì´ ê¸°ìš¸ì–´ì§„ ì±„ë¡œ íƒœì–‘ ì£¼ìœ„ë¥¼ ëˆë‹¤ë©´, ì–´ëŠ ìª½ ë°˜êµ¬ê°€ ë” í–‡ë¹›ì„ ë§ì´ ë°›ì„ê¹Œìš”?",
                    "ê¸°ìš¸ê¸°ê°€ ì—†ë‹¤ë©´ ê³„ì ˆì€ ì–´ë–»ê²Œ ë ì§€ ìƒìƒí•´ ë³´ê²Œ í•´ ì£¼ì„¸ìš”.",
                ],
                "teacher_point": "â€˜ê¸°ìš¸ì–´ì§â€™ê³¼ â€˜ê³µì „â€™ì„ ë°˜ë“œì‹œ í•¨ê»˜ ì–¸ê¸‰í•˜ì—¬, ìì „ì¶• ê¸°ìš¸ê¸°ê°€ ê³„ì ˆê³¼ ì–´ë–»ê²Œ ì—°ê²°ë˜ëŠ”ì§€ ì •êµí™”í•©ë‹ˆë‹¤.",
            },
        },
        {
            "id": "summary_sentence",
            "stage": "ì •ë¦¬",
            "label": "ì •ë¦¬: í•œ ë¬¸ì¥ìœ¼ë¡œ ê³„ì ˆ ì„¤ëª…",
            "question": "ê³„ì ˆì´ ìƒê¸°ëŠ” ê¹Œë‹­ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ë§í•´ ë³¼ê¹Œìš”?",
            "expected_answers": [
                "ì§€êµ¬ì˜ ìì „ì¶•ì´ ê¸°ìš¸ì–´ì§„ ì±„ë¡œ íƒœì–‘ ì£¼ìœ„ë¥¼ ê³µì „í•˜ê¸° ë•Œë¬¸ì— ê³„ì ˆì´ ìƒê²¨ìš”.",
                "ì§€êµ¬ê°€ ê¸°ìš¸ì–´ì§„ ì±„ë¡œ ë„ëŠ” ë™ì•ˆ íƒœì–‘ë¹›ì´ ë¹„ì¶”ëŠ” ê°ë„ì™€ ë‚®ì˜ ê¸¸ì´ê°€ ë‹¬ë¼ì ¸ì„œ ê³„ì ˆì´ ìƒê²¨ìš”.",
            ],
            "feedback_rules": {},
            "resources": [
                {
                    "id": "summary_card",
                    "title": "ê³„ì ˆ ê°œë… í•œ ì¥ ì •ë¦¬ ì¹´ë“œ",
                    "type": "image",
                    "default_url": "https://example.com/season-summary-card.png",
                    "description": "ìˆ˜ì—… ë§ˆì§€ë§‰ì— í•¨ê»˜ ì½ì„ ìˆ˜ ìˆëŠ” ê³„ì ˆ ê°œë… ìš”ì•½ ì¹´ë“œì…ë‹ˆë‹¤.",
                }
            ],
            "teacher_notes": {
                "extra_questions": [
                    "ë°©ê¸ˆ ë§í•´ ì¤€ ë¬¸ì¥ì—ì„œ ê¼­ ë“¤ì–´ê°€ì•¼ í•œë‹¤ê³  ìƒê°í•˜ëŠ” ë‹¨ì–´ë¥¼ ë°‘ì¤„ ê·¸ì–´ ë³¼ê¹Œìš”? (ì˜ˆ: ìì „ì¶•, ê¸°ìš¸ê¸°, ê³µì „)",
                    "ì¹œêµ¬ì—ê²Œ ì„¤ëª…í•˜ë“¯ì´, ì¡°ê¸ˆ ë” ì‰½ê²Œ í’€ì–´ì„œ ë‹¤ì‹œ ë§í•´ ë³¼ ìˆ˜ ìˆì„ê¹Œìš”?",
                ],
                "teacher_point": "í•™ìƒì´ ìŠ¤ìŠ¤ë¡œ ë§Œë“  ë¬¸ì¥ì„ ì¡´ì¤‘í•˜ê³ , ë¹ ì§„ í•µì‹¬ì–´(ìì „ì¶•, ê¸°ìš¸ê¸°, ê³µì „, íƒœì–‘ë¹› ê°ë„)ë¥¼ í•˜ë‚˜ì”© ë³´ì™„í•´ ì¤ë‹ˆë‹¤.",
            },
        },
    ]


# -----------------------------
# í”¼ë“œë°± ê·œì¹™ ì—”ì§„
# -----------------------------
def classify_answer(answer: str) -> str:
    """í•™ìƒ ë‹µë³€ì„ ê°„ë‹¨í•œ í‚¤ì›Œë“œ ê¸°ë°˜ìœ¼ë¡œ ë¶„ë¥˜í•©ë‹ˆë‹¤."""
    if not answer or not answer.strip():
        return "empty"

    text = answer.replace(" ", "").lower()

    distance_keywords = ["ê±°ë¦¬", "ê°€ê¹Œì›Œ", "ê°€ê¹Œì›Œì„œ", "ë©€ì–´", "ë©€ì–´ì„œ", "distance"]
    tilt_keywords = ["ìì „ì¶•", "ê¸°ìš¸", "23.5", "23ë„", "ì¶•ì´ê¸°ìš¸ì–´", "axis", "tilt"]
    angle_keywords = ["ê°ë„", "ë¹„ìŠ¤ë“¬", "ìˆ˜ì§", "ë‚¨ì¤‘ê³ ë„", "íƒœì–‘ê³ ë„", "ë†’ì´"]
    daylength_keywords = ["ë‚®ì´", "ë°¤ì´", "ë‚®ê¸¸ì´", "ë°¤ê¸¸ì´", "ë‚®ê³¼ë°¤", "í•´ê°€ê¸¸ê²Œ", "í•´ê°€ì§§ê²Œ"]

    if any(k in text for k in distance_keywords):
        return "distance"
    if any(k in text for k in tilt_keywords):
        return "tilt"
    if any(k in text for k in angle_keywords):
        return "angle"
    if any(k in text for k in daylength_keywords):
        return "daylength"

    return "other"


def build_feedback(answer: str, card: Dict) -> str:
    """
    ê·œì¹™ ê¸°ë°˜ìœ¼ë¡œ í”¼ë“œë°± ë¬¸ë‹¨ì„ ìƒì„±í•©ë‹ˆë‹¤.
    í˜•ì‹: ê²°ë¡  1ë¬¸ì¥ + ë³´ì™„ 2~3ë¬¸ì¥ + í™•ì¸ ì§ˆë¬¸ 1ê°œ
    """
    category = classify_answer(answer)

    # ê³µí†µ: í•™ìƒ ë‹µ ì¡´ì¤‘ ë¬¸ì¥
    if answer and answer.strip():
        head = f"\"{answer}\"ë¼ê³  ìƒê°í•´ ì¤€ ì ì´ ì •ë§ ì¢‹ìŠµë‹ˆë‹¤. ìŠ¤ìŠ¤ë¡œ ê³„ì ˆì´ ìƒê¸°ëŠ” ê¹Œë‹­ì„ ê³ ë¯¼í•´ ë³¸ ê²ƒë§Œìœ¼ë¡œë„ í° ë°°ì›€ì´ì—ìš”."
    else:
        head = "ì•„ì§ ìƒê°ì„ ì ì§€ ì•Šì•˜ë„¤ìš”. ë– ì˜¤ë¥´ëŠ” ìƒê°ì„ í¸í•˜ê²Œ í•œ ë¬¸ì¥ì´ë¼ë„ ì ì–´ ë³´ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤."

    lines: List[str] = [head]

    if category == "distance":
        lines.append(
            "ë§ì€ ì¹œêµ¬ë“¤ì´ íƒœì–‘ê³¼ ì§€êµ¬ ì‚¬ì´ì˜ **ê±°ë¦¬ê°€ ê°€ê¹Œì›Œì§€ë©´ ì—¬ë¦„, ë©€ì–´ì§€ë©´ ê²¨ìš¸**ì´ ëœë‹¤ê³  ìƒê°í•˜ì§€ë§Œ, ì‹¤ì œë¡œ ê±°ë¦¬ëŠ” 1ë…„ ë™ì•ˆ í¬ê²Œ ë‹¬ë¼ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤."
        )
        lines.append(
            "ê·¸ë˜ì„œ ê³„ì ˆì„ ì„¤ëª…í•  ë•ŒëŠ” ê±°ë¦¬ë³´ë‹¤ **ì§€êµ¬ì˜ ìì „ì¶•ì´ ê¸°ìš¸ì–´ì§„ ì±„ë¡œ ê³µì „í•œë‹¤ëŠ” ì **ê³¼, ê·¸ ë•Œë¬¸ì— **íƒœì–‘ë¹›ì´ ë¹„ì¶”ëŠ” ê°ë„ì™€ ë‚® ê¸¸ì´ê°€ ë‹¬ë¼ì§„ë‹¤**ëŠ” ì ì´ ë” ì¤‘ìš”í•´ìš”."
        )
        lines.append(
            "ë§Œì•½ ê±°ë¦¬ê°€ ê³„ì ˆì˜ ì£¼ëœ ì´ìœ ë¼ë©´, ì§€êµ¬ê°€ íƒœì–‘ì—ì„œ ê°€ì¥ ë©€ì–´ì§ˆ ë•Œ ìš°ë¦¬ë‚˜ë¼ì—ëŠ” ì–´ë–¤ ê³„ì ˆì´ ì™€ì•¼ í• ì§€ ë‹¤ì‹œ í•œ ë²ˆ í•¨ê»˜ ìƒê°í•´ ë³¼ê¹Œìš”?"
        )
    elif category == "tilt":
        lines.append(
            "ìì „ì¶• ê¸°ìš¸ê¸°ë¥¼ ì–¸ê¸‰í•´ ì¤€ ê²ƒì€ ì•„ì£¼ ì¤‘ìš”í•œ í¬ì¸íŠ¸ì˜ˆìš”. ê³„ì ˆì´ ìƒê¸°ëŠ” ê¹Œë‹­ì„ ê±°ì˜ ì •í™•í•˜ê²Œ ì§šì€ ì…ˆì…ë‹ˆë‹¤."
        )
        lines.append(
            "ì§€êµ¬ì˜ ìì „ì¶•ì´ ì•½ 23.5ë„ ê¸°ìš¸ì–´ì§„ ì±„ë¡œ íƒœì–‘ ì£¼ìœ„ë¥¼ ê³µì „í•˜ê¸° ë•Œë¬¸ì—, ì–´ë–¤ ë•Œì—ëŠ” ìš°ë¦¬ë‚˜ë¼ ìª½ì´ íƒœì–‘ì„ ë” ì •ë©´ìœ¼ë¡œ ë°”ë¼ë³´ê³ , ì–´ë–¤ ë•Œì—ëŠ” ë” ë¹„ìŠ¤ë“¬íˆ ë°”ë¼ë³´ê²Œ ë©ë‹ˆë‹¤."
        )
        lines.append(
            "ì´ë ‡ê²Œ íƒœì–‘ë¹›ì´ ë¹„ì¶”ëŠ” ê°ë„ì™€ ë‚®ì˜ ê¸¸ì´ê°€ ë‹¬ë¼ì§€ë©´ì„œ ì—¬ë¦„Â·ê²¨ìš¸ ê°™ì€ ê³„ì ˆ ì°¨ì´ê°€ ë‚˜íƒ€ë‚˜ëŠ”ë°, ì´ ì—°ê²°ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ë‹¤ì‹œ ì •ë¦¬í•´ ë³¼ê¹Œìš”?"
        )
    elif category == "angle":
        lines.append(
            "í–‡ë¹›ì´ **ìˆ˜ì§ì— ê°€ê¹ê²Œ** ë˜ëŠ” **ë¹„ìŠ¤ë“¬íˆ** ë“¤ì–´ì˜¨ë‹¤ëŠ” ì ì„ ë– ì˜¬ë¦° ê²ƒì€ ê³¼í•™ì ìœ¼ë¡œ ì•„ì£¼ ë‚ ì¹´ë¡œìš´ ìƒê°ì´ì—ìš”."
        )
        lines.append(
            "ê°™ì€ ì–‘ì˜ í–‡ë¹›ì´ë¼ë„ ìˆ˜ì§ì— ê°€ê¹ê²Œ ë“¤ì–´ì˜¤ë©´ **ì‘ì€ ë©´ì ì— ë¹›ì´ ëª¨ì—¬ì„œ** ë” ëœ¨ê²ê²Œ ëŠê»´ì§€ê³ , ë¹„ìŠ¤ë“¬íˆ ë“¤ì–´ì˜¤ë©´ **ë„“ì€ ë©´ì ì— í¼ì ¸ì„œ** ì•½í•˜ê²Œ ëŠê»´ì§‘ë‹ˆë‹¤."
        )
        lines.append(
            "ì†ì „ë“±ì„ ì±…ìƒì— ë°”ë¡œ ìœ„ì—ì„œ ë¹„ì¶œ ë•Œì™€ ì˜†ì—ì„œ ë¹„ì¶œ ë•Œì˜ ë°ê¸°ë¥¼ ë– ì˜¬ë¦¬ë©´ì„œ, ì´ ìƒê°ì„ ê³„ì ˆ ë³€í™”ì™€ ì–´ë–»ê²Œ ì—°ê²°í•  ìˆ˜ ìˆì„ì§€ í•œ ë²ˆ ë” ë§í•´ ë³¼ê¹Œìš”?"
        )
    elif category == "daylength":
        lines.append(
            "ë‚®ì˜ ê¸¸ì´ì™€ ë°¤ì˜ ê¸¸ì´ì— ì£¼ëª©í•œ ê²ƒì€ ê³„ì ˆì„ ì´í•´í•˜ëŠ” ë° ë§¤ìš° ì¤‘ìš”í•œ ê´€ì°°ì´ì—ìš”."
        )
        lines.append(
            "ì§€êµ¬ì˜ ìì „ì¶•ì´ ê¸°ìš¸ì–´ì§„ ì±„ë¡œ ê³µì „í•˜ë©´ì„œ, ì–´ë–¤ ë•Œì—ëŠ” ìš°ë¦¬ë‚˜ë¼ê°€ íƒœì–‘ì„ ë” ì˜¤ë˜ ë°”ë¼ë³´ê²Œ ë˜ì–´ **ë‚®ì´ ê¸¸ì–´ì§€ê³ ** ì—¬ë¦„ì²˜ëŸ¼ ëŠê»´ì§€ê³ , "
            "ì–´ë–¤ ë•Œì—ëŠ” ëœ ë°”ë¼ë³´ê²Œ ë˜ì–´ **ë°¤ì´ ê¸¸ì–´ì§€ê³ ** ê²¨ìš¸ì²˜ëŸ¼ ëŠê»´ì§‘ë‹ˆë‹¤."
        )
        lines.append(
            "ì§€ê¸ˆ ë– ì˜¬ë¦° ë‚®ê³¼ ë°¤ì˜ ê¸¸ì´ ì°¨ì´ë¥¼, ìì „ì¶• ê¸°ìš¸ê¸°ì™€ ê³µì „ì´ë¼ëŠ” ë§ê³¼ í•¨ê»˜ í•œ ë¬¸ì¥ìœ¼ë¡œ ë‹¤ì‹œ ì„¤ëª…í•´ ë³¼ ìˆ˜ ìˆì„ê¹Œìš”?"
        )
    elif category == "other":
        lines.append(
            "ì§€ê¸ˆ ì ì–´ ì¤€ ìƒê° ì†ì—ë„ ë¶„ëª…íˆ ì¤‘ìš”í•œ ë‹¨ì„œë“¤ì´ ìˆ¨ì–´ ìˆì–´ìš”. ì•„ì§ì€ ì¡°ê¸ˆ ë§‰ì—°í•˜ê²Œ ëŠê»´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        )
        lines.append(
            "ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ, **íƒœì–‘ì˜ ë†’ì´**, **í–‡ë¹›ì´ ë¹„ì¶”ëŠ” ê°ë„**, **ë‚®ê³¼ ë°¤ì˜ ê¸¸ì´** ì¤‘ì—ì„œ ë¬´ì—‡ê³¼ ê°€ì¥ ê´€ë ¨ì´ ìˆì„ì§€ í•˜ë‚˜ ê³¨ë¼ì„œ ë‹¤ì‹œ ì„¤ëª…í•´ ë³´ë©´ ì¢‹ì•„ìš”."
        )
        lines.append(
            "ì§€ê¸ˆ ìƒê°í•œ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ, \"ì–´ë–¤ ê³„ì ˆì—ëŠ” íƒœì–‘ì´ ì–´ë–»ê²Œ ë³´ì´ê³ , ê·¸ë˜ì„œ ë¬´ì—‡ì´ ë‹¬ë¼ì§„ë‹¤\"ëŠ” ì‹ìœ¼ë¡œ í•œ ë²ˆ ë” ë§í•´ ë³¼ê¹Œìš”?"
        )
    else:  # empty
        lines.append(
            "ì²˜ìŒë¶€í„° ì™„ë²½í•œ ë‹µì„ ì“°ë ¤ê³  í•˜ê¸°ë³´ë‹¤, ë– ì˜¤ë¥´ëŠ” ë‹¨ì–´ ë‘ì„¸ ê°œë§Œ ì ì–´ ë³´ëŠ” ê²ƒë„ ì¢‹ì€ ì‹œì‘ì…ë‹ˆë‹¤."
        )
        lines.append(
            "ì˜ˆë¥¼ ë“¤ì–´ 'íƒœì–‘ë¹›ì˜ ê°ë„', 'ìì „ì¶• ê¸°ìš¸ê¸°', 'ë‚®ì˜ ê¸¸ì´'ì²˜ëŸ¼, ê³„ì ˆê³¼ ê´€ë ¨ì´ ìˆì„ ê²ƒ ê°™ì€ ë§ì„ í•˜ë‚˜ ê³¨ë¼ ì ì–´ ë³´ì„¸ìš”."
        )
        lines.append(
            "ì´ ì¤‘ì—ì„œ ì–´ë–¤ ë‹¨ì–´ê°€ ê³„ì ˆê³¼ ê°€ì¥ ê¹Šì€ ê´€ë ¨ì´ ìˆì„ì§€, ë‹¤ìŒ ì°¨ë¡€ì— ë§ë¡œ ì„¤ëª…í•´ ë³¼ ìˆ˜ ìˆì„ê¹Œìš”?"
        )

    return "\n\n".join(lines)


# -----------------------------
# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
# -----------------------------
if "cards" not in st.session_state:
    st.session_state.cards = get_default_cards()

if "resource_urls" not in st.session_state:
    # card_id -> resource_id -> url
    st.session_state.resource_urls = {}


def get_cards() -> List[Dict]:
    return st.session_state.cards


def get_card_by_id(card_id: str) -> Dict:
    for c in get_cards():
        if c["id"] == card_id:
            return c
    return get_cards()[0]


def get_resource_url(card_id: str, res: Dict) -> str:
    card_urls = st.session_state.resource_urls.setdefault(card_id, {})
    return card_urls.get(res["id"], res.get("default_url", ""))


def set_resource_url(card_id: str, res_id: str, url: str) -> None:
    card_urls = st.session_state.resource_urls.setdefault(card_id, {})
    card_urls[res_id] = url


# -----------------------------
# ë ˆì´ì•„ì›ƒ: ì‚¬ì´ë“œë°”
# -----------------------------
with st.sidebar:
    st.header("âš™ï¸ ìˆ˜ì—… ì„¤ì •")

    # ì¹´ë“œ ì„ íƒ
    cards = get_cards()
    options = {f"[{c['stage']}] {c['label']}": c["id"] for c in cards}
    selected_label = st.selectbox("ì‚¬ìš©í•  ë°œë¬¸ ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.", list(options.keys()))
    selected_card_id = options[selected_label]

    # êµì‚¬ìš© ëª¨ë“œ
    teacher_mode = st.toggle("êµì‚¬ìš© ëª¨ë“œ ë³´ê¸°", value=True)

    st.markdown("---")
    st.subheader("ğŸ“ ìë£Œ ë§í¬ ì„¤ì •")
    st.caption("í•™êµì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¯¸ì§€/ì˜ìƒ URLë¡œ ë°”ê¾¸ì–´ ì‚¬ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

    current_card = get_card_by_id(selected_card_id)
    for res in current_card.get("resources", []):
        current_url = get_resource_url(current_card["id"], res)
        new_url = st.text_input(
            f"{res['title']} URL",
            value=current_url,
            key=f"url_{current_card['id']}_{res['id']}",
        )
        set_resource_url(current_card["id"], res["id"], new_url)


# -----------------------------
# ë©”ì¸ ë ˆì´ì•„ì›ƒ
# -----------------------------
st.title("ğŸŒ ê³„ì ˆ ë³€í™”ê°€ ìƒê¸°ëŠ” ê¹Œë‹­ - ë°œë¬¸ ì¤‘ì‹¬ ìˆ˜ì—… ë³´ì¡° ì•±")
st.markdown(
    """
ì´ ì•±ì€ **ë°œë¬¸ â†’ í•™ìƒ ì‘ë‹µ â†’ ê·œì¹™ ê¸°ë°˜ í”¼ë“œë°± â†’ ì‹œê° ìë£Œ** íë¦„ìœ¼ë¡œ  
í•™ìƒë“¤ì˜ ê³¼í•™ì  ì‚¬ê³ ë¥¼ ìê·¹í•˜ë„ë¡ ì„¤ê³„ëœ **ìˆ˜ì—… ë³´ì¡° ë„êµ¬**ì…ë‹ˆë‹¤.  
"""
)
st.markdown("---")

tab_lesson, tab_summary = st.tabs(["ë°œë¬¸ ì¹´ë“œ í™œìš©", "í•œ ì¥ ì •ë¦¬"])


# -----------------------------
# íƒ­ 1: ë°œë¬¸ ì¹´ë“œ í™œìš©
# -----------------------------
with tab_lesson:
    card = current_card

    st.markdown(f"#### ë‹¨ê³„: {card['stage']}")
    st.markdown(f"**ë°œë¬¸**")
    st.markdown(f"ğŸ‘‰ **{card['question']}**")

    st.markdown("##### í•™ìƒ ë‹µ ì…ë ¥")
    answer = st.text_area(
        "í•™ìƒì´ ì‹¤ì œë¡œ ë§í•œ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ì ì–´ ì£¼ì„¸ìš”.",
        key=f"answer_{card['id']}",
        height=100,
        placeholder="ì˜ˆ) ì—¬ë¦„ì—ëŠ” íƒœì–‘ì´ ê°€ê¹Œì›Œì ¸ì„œ ë”ì›Œì§€ê³ , ê²¨ìš¸ì—ëŠ” ë©€ì–´ì ¸ì„œ ì¶”ì›Œì§„ ê²ƒ ê°™ì•„ìš”.",
    )

    col_fb, col_res = st.columns(2)
    with col_fb:
        show_feedback = st.button("í”¼ë“œë°± ë³´ê¸°", key=f"fb_btn_{card['id']}")
    with col_res:
        show_resources = st.button("ì¶”ê°€ ìë£Œ ë³´ê¸°", key=f"res_btn_{card['id']}")

    # í”¼ë“œë°± ì˜ì—­
    if show_feedback:
        st.markdown("---")
        st.subheader("ğŸ’¬ ê·œì¹™ ê¸°ë°˜ í”¼ë“œë°±")
        feedback_text = build_feedback(answer, card)
        st.write(feedback_text)

    # ì¶”ê°€ ìë£Œ ì˜ì—­
    if show_resources:
        st.markdown("---")
        st.subheader("ğŸ“š ì¶”ê°€ ìë£Œ")
        resources = card.get("resources", [])
        if not resources:
            st.info("ì´ ì¹´ë“œì— ë“±ë¡ëœ ìë£Œê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”ì—ì„œ URLì„ ì¶”ê°€í•´ ë³´ì„¸ìš”.")
        else:
            for res in resources:
                url = get_resource_url(card["id"], res)
                st.markdown(f"**{res['title']}**")
                if res.get("description"):
                    st.caption(res["description"])

                if url:
                    if res["type"] == "image":
                        st.image(url, use_column_width=True)
                    elif res["type"] == "video":
                        st.video(url)
                    else:
                        st.markdown(f"[ìë£Œ ì—´ê¸°]({url})")
                else:
                    st.info("URLì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”ì—ì„œ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
                st.markdown("---")

    # êµì‚¬ìš© ëª¨ë“œ
    if teacher_mode:
        st.markdown("---")
        st.subheader("ğŸ‘©â€ğŸ« êµì‚¬ìš© ì•ˆë‚´")

        exp = card.get("expected_answers", [])
        if exp:
            st.markdown("**ì˜ˆìƒ í•™ìƒ ë°˜ì‘ ì˜ˆì‹œ (2~3ê°œ)**")
            for i, e in enumerate(exp, start=1):
                st.markdown(f"- ({i}) {e}")

        notes = card.get("teacher_notes", {})
        extra_q = notes.get("extra_questions", [])
        if extra_q:
            st.markdown("**ì¶”ê°€ ë°œë¬¸ ì œì•ˆ (2ê°œ)**")
            for q in extra_q[:2]:
                st.markdown(f"- {q}")

        point = notes.get("teacher_point")
        if point:
            st.markdown("**ì§€ë„ í¬ì¸íŠ¸ (1ê°œ)**")
            st.write(point)


# -----------------------------
# íƒ­ 2: í•œ ì¥ ì •ë¦¬
# -----------------------------
with tab_summary:
    st.header("ğŸ“„ ê³„ì ˆì´ ìƒê¸°ëŠ” ê¹Œë‹­ - í•œ ì¥ ì •ë¦¬")
    st.markdown(
        """
- ì§€êµ¬ì˜ **ìì „ì¶•ì€ ì•½ 23.5ë„ ê¸°ìš¸ì–´ì ¸** ìˆìŠµë‹ˆë‹¤.  
- ì´ ê¸°ìš¸ì–´ì§„ ìƒíƒœë¡œ ì§€êµ¬ê°€ **íƒœì–‘ ì£¼ìœ„ë¥¼ 1ë…„ì— í•œ ë°”í€´ ê³µì „**í•©ë‹ˆë‹¤.  
- ê·¸ë˜ì„œ ì–´ë–¤ ë•Œì—ëŠ” ìš°ë¦¬ë‚˜ë¼ ìª½ì´ íƒœì–‘ì„ ë” ì •ë©´ìœ¼ë¡œ ë°”ë¼ë³´ê³ , ì–´ë–¤ ë•Œì—ëŠ” ë” ë¹„ìŠ¤ë“¬íˆ ë°”ë¼ë³´ê²Œ ë©ë‹ˆë‹¤.  
- ê·¸ ê²°ê³¼, í•œ ì¥ì†Œì—ì„œë„ **íƒœì–‘ì˜ ë†’ì´(íƒœì–‘ ê³ ë„)** ì™€ **í–‡ë¹›ì´ ë¹„ì¶”ëŠ” ê°ë„**, **ë‚®ê³¼ ë°¤ì˜ ê¸¸ì´**ê°€ ê³„ì ˆì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤.  
- íƒœì–‘ë¹›ì´ ë” **ìˆ˜ì§ì— ê°€ê¹ê²Œ** ë“¤ì–´ì˜¤ê³  ë‚®ì´ ê¸¸ì–´ì§ˆìˆ˜ë¡ ì—¬ë¦„ì²˜ëŸ¼ ë” **ëœ¨ê²ê³  ë°ê²Œ**,  
  ë” **ë¹„ìŠ¤ë“¬íˆ** ë“¤ì–´ì˜¤ê³  ë‚®ì´ ì§§ì•„ì§ˆìˆ˜ë¡ ê²¨ìš¸ì²˜ëŸ¼ ë” **ì„ ì„ í•˜ê³  ì–´ë‘¡ê²Œ** ëŠê»´ì§‘ë‹ˆë‹¤.
"""
    )

    st.markdown("---")
    st.markdown("### ìˆ˜ì—… ë§ˆë¬´ë¦¬ ì²´í¬ë¦¬ìŠ¤íŠ¸")
    st.checkbox("ì—¬ë¦„ê³¼ ê²¨ìš¸ì— íƒœì–‘ì˜ ë†’ì´ì™€ ê·¸ë¦¼ì ê¸¸ì´ ì°¨ì´ë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤.", key="chk_sun_height")
    st.checkbox("í–‡ë¹›ì˜ ì…ì‚¬ê°(ìˆ˜ì§/ë¹„ìŠ¤ë“¬íˆ)ê³¼ ë‹¨ìœ„ ë©´ì ë‹¹ ì—ë„ˆì§€ ì–‘ì˜ ê´€ê³„ë¥¼ ë§í•  ìˆ˜ ìˆë‹¤.", key="chk_angle_energy")
    st.checkbox("ê³„ì ˆì´ íƒœì–‘ê³¼ì˜ ê±°ë¦¬ ë•Œë¬¸ì´ë¼ëŠ” ìƒê°ì´ ì™œ ì •í™•í•˜ì§€ ì•Šì€ì§€ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤.", key="chk_distance_misconception")
    st.checkbox("ìì „ì¶• ê¸°ìš¸ê¸°ì™€ ê³µì „ì´ ê³„ì ˆê³¼ ì–´ë–»ê²Œ ì—°ê²°ë˜ëŠ”ì§€ í•œ ë¬¸ì¥ìœ¼ë¡œ ë§í•  ìˆ˜ ìˆë‹¤.", key="chk_tilt_orbit")

    st.markdown("---")
    st.markdown(
        """
### ì„ ìƒë‹˜ê»˜ ë“œë¦¬ëŠ” ì œì•ˆ
- ì´ ì •ë¦¬ íƒ­ì€ í•™ìƒë“¤ì—ê²Œ ê·¸ëŒ€ë¡œ ì½ì–´ ì£¼ê¸°ë³´ë‹¤ëŠ”, ìˆ˜ì—…ì´ ëë‚  ë¬´ë µ **ì„ ìƒë‹˜ì˜ ì •ë¦¬ ë©”ëª¨**ì²˜ëŸ¼ í™œìš©í•´ ì£¼ì„¸ìš”.  
- í•™ìƒì´ ë¨¼ì € ìê¸° ë§ë¡œ ì •ë¦¬í•œ ë’¤, ë¹ ì§„ ë¶€ë¶„ì´ë‚˜ í—·ê°ˆë ¤ í•˜ëŠ” ë¶€ë¶„ì„ ë³´ì™„í•  ë•Œ ì°¸ê³  ìë£Œë¡œ ì“°ì‹œë©´ ì¢‹ìŠµë‹ˆë‹¤.
"""
    )

